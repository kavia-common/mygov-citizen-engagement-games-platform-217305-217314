{"is_source_file": true, "format": "Python", "description": "This file defines FastAPI routes and logic for managing games and scores, including listing, retrieving, scoring, and broadcasting updates for a gaming platform. It also contains database schema definitions and helper functions for data access and conversion.", "external_files": ["src.api.main", "src.api.routes.ws"], "external_methods": ["get_db_conn", "notify_leaderboard_update"], "published": ["list_games", "get_game", "get_game_scores", "post_game_score"], "classes": [{"name": "Game", "description": "Pydantic model representing a game with ID, slug, name, description, and creation timestamp."}, {"name": "GameListResponse", "description": "Response model for paginated list of games."}, {"name": "ScoreItem", "description": "Model representing a score record with ID, user ID, score, and timestamp."}, {"name": "ScoresResponse", "description": "Response model for scores, including game info, score items, mode, and limit."}, {"name": "PostScoreRequest", "description": "Request model for submitting a new score, including user ID and score value with validation."}, {"name": "PostScoreResponse", "description": "Response after submitting a score, including game info, inserted score details, and stats."}], "methods": [{"name": "None _ensure_schema(conn: sqlite3.Connection)", "description": "Ensures the database schema and indexes are created.", "scope": "", "scopeKind": ""}, {"name": "Game _row_to_game(row: sqlite3.Row)", "description": "Converts a database row into a Game object.", "scope": "", "scopeKind": ""}, {"name": "ScoreItem _row_to_score(row: sqlite3.Row)", "description": "Converts a database row into a ScoreItem object.", "scope": "", "scopeKind": ""}, {"name": "Optional[Game] _get_game_by_id(conn: sqlite3.Connection, game_id: int)", "description": "Retrieves a game record by its ID.", "scope": "", "scopeKind": ""}, {"name": "Tuple[int,int] _paginate(offset: int, limit: int)", "description": "Calculates offset and limit with constraints.", "scope": "", "scopeKind": ""}, {"name": "GameListResponse list_games( page: int = Query(1, ge=1, description=\"1-based page number\"), size: int = Query(10, ge=1, le=100, description=\"Page size\"), db: sqlite3.Connection = Depends(get_db_conn), )", "description": "API route to list games with pagination.", "scope": "", "scopeKind": ""}, {"name": "Game get_game(game_id: int, db: sqlite3.Connection = Depends(get_db_conn))", "description": "API route to retrieve game details by ID.", "scope": "", "scopeKind": ""}, {"name": "ScoresResponse get_game_scores( game_id: int, mode: Literal[\"recent\", \"top\"] = Query( \"recent\", description=\"Select 'recent' for latest scores or 'top' for highest\" ), limit: int = Query(10, ge=1, le=100, description=\"Max number of scores to return\"), db: sqlite3.Connection = Depends(get_db_conn), )", "description": "API route to get recent or top scores for a game.", "scope": "", "scopeKind": ""}, {"name": "ScoreItem _insert_score( conn: sqlite3.Connection, game_id: int, user_id: int, score: int )", "description": "Inserts a new score into the database and returns the score object.", "scope": "", "scopeKind": ""}, {"name": "Dict[str,Any] _score_stats(conn: sqlite3.Connection, game_id: int)", "description": "Retrieves total score count and top score for a game.", "scope": "", "scopeKind": ""}, {"name": "PostScoreResponse post_game_score( game_id: int, payload: PostScoreRequest, db: sqlite3.Connection = Depends(get_db_conn) )", "description": "API route to submit a new score for a game, triggers broadcast.", "scope": "", "scopeKind": ""}, {"name": "int _score_int(cls, v: int)", "scope": "PostScoreRequest", "scopeKind": "class", "description": "unavailable"}], "calls": ["get_db_conn", "notify_leaderboard_update", "_ensure_schema", "_row_to_game", "_row_to_score", "_get_game_by_id", "_paginate", "_insert_score", "_score_stats", "asyncio.get_event_loop", "asyncio.run"], "search-terms": ["FastAPI game scores", "SQLite schema", "submit game score", "leaderboard notifications", "games list endpoint", "score retrieval", "broadcast websocket updates"], "state": 2, "file_id": 9, "knowledge_revision": 34, "git_revision": "cd0dc9336d4ce838a7bfb4872116d8553d791a9a", "revision_history": [{"25": "cd0dc9336d4ce838a7bfb4872116d8553d791a9a"}, {"34": "cd0dc9336d4ce838a7bfb4872116d8553d791a9a"}], "ctags": [{"_type": "tag", "name": "CREATE_GAMES_SQL", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^CREATE_GAMES_SQL = \"\"\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "CREATE_INDEXES_SQL", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^CREATE_INDEXES_SQL: Tuple[str, ...] = ($/", "language": "Python", "typeref": "typename:Tuple[str, ...]", "kind": "variable"}, {"_type": "tag", "name": "CREATE_SCORES_SQL", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^CREATE_SCORES_SQL = \"\"\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "Game", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^class Game(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "GameListResponse", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^class GameListResponse(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "PostScoreRequest", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^class PostScoreRequest(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "PostScoreResponse", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^class PostScoreResponse(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "ScoreItem", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^class ScoreItem(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "ScoresResponse", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^class ScoresResponse(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "_ensure_schema", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^def _ensure_schema(conn: sqlite3.Connection) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(conn: sqlite3.Connection)"}, {"_type": "tag", "name": "_get_game_by_id", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^def _get_game_by_id(conn: sqlite3.Connection, game_id: int) -> Optional[Game]:$/", "language": "Python", "typeref": "typename:Optional[Game]", "kind": "function", "signature": "(conn: sqlite3.Connection, game_id: int)"}, {"_type": "tag", "name": "_insert_score", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^def _insert_score($/", "language": "Python", "typeref": "typename:ScoreItem", "kind": "function", "signature": "( conn: sqlite3.Connection, game_id: int, user_id: int, score: int )"}, {"_type": "tag", "name": "_paginate", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^def _paginate(offset: int, limit: int) -> Tuple[int, int]:$/", "language": "Python", "typeref": "typename:Tuple[int,int]", "kind": "function", "signature": "(offset: int, limit: int)"}, {"_type": "tag", "name": "_row_to_game", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^def _row_to_game(row: sqlite3.Row) -> Game:$/", "language": "Python", "typeref": "typename:Game", "kind": "function", "signature": "(row: sqlite3.Row)"}, {"_type": "tag", "name": "_row_to_score", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^def _row_to_score(row: sqlite3.Row) -> ScoreItem:$/", "language": "Python", "typeref": "typename:ScoreItem", "kind": "function", "signature": "(row: sqlite3.Row)"}, {"_type": "tag", "name": "_score_int", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    def _score_int(cls, v: int) -> int:$/", "language": "Python", "typeref": "typename:int", "kind": "member", "signature": "(cls, v: int)", "scope": "PostScoreRequest", "scopeKind": "class"}, {"_type": "tag", "name": "_score_stats", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^def _score_stats(conn: sqlite3.Connection, game_id: int) -> Dict[str, Any]:$/", "language": "Python", "typeref": "typename:Dict[str,Any]", "kind": "function", "signature": "(conn: sqlite3.Connection, game_id: int)"}, {"_type": "tag", "name": "created_at", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    created_at: Optional[str] = Field(None, description=\"Creation timestamp\")$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "Game", "scopeKind": "class"}, {"_type": "tag", "name": "created_at", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    created_at: Optional[str] = Field(None, description=\"When the score was recorded\")$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "ScoreItem", "scopeKind": "class"}, {"_type": "tag", "name": "description", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    description: Optional[str] = Field(None, description=\"Game description\")$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "Game", "scopeKind": "class"}, {"_type": "tag", "name": "game", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    game: Game = Field(..., description=\"Game info\")$/", "language": "Python", "typeref": "typename:Game", "kind": "variable", "scope": "PostScoreResponse", "scopeKind": "class"}, {"_type": "tag", "name": "game", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    game: Game = Field(..., description=\"Game info\")$/", "language": "Python", "typeref": "typename:Game", "kind": "variable", "scope": "ScoresResponse", "scopeKind": "class"}, {"_type": "tag", "name": "get_game", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^def get_game(game_id: int, db: sqlite3.Connection = Depends(get_db_conn)) -> Game:$/", "language": "Python", "typeref": "typename:Game", "kind": "function", "signature": "(game_id: int, db: sqlite3.Connection = Depends(get_db_conn))"}, {"_type": "tag", "name": "get_game_scores", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^def get_game_scores($/", "language": "Python", "typeref": "typename:ScoresResponse", "kind": "function", "signature": "( game_id: int, mode: Literal[\"recent\", \"top\"] = Query( \"recent\", description=\"Select 'recent' for latest scores or 'top' for highest\" ), limit: int = Query(10, ge=1, le=100, description=\"Max number of scores to return\"), db: sqlite3.Connection = Depends(get_db_conn), )"}, {"_type": "tag", "name": "id", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    id: int = Field(..., description=\"Game ID\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "Game", "scopeKind": "class"}, {"_type": "tag", "name": "id", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    id: int = Field(..., description=\"Score row ID\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "ScoreItem", "scopeKind": "class"}, {"_type": "tag", "name": "inserted", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    inserted: ScoreItem = Field(..., description=\"Inserted score row\")$/", "language": "Python", "typeref": "typename:ScoreItem", "kind": "variable", "scope": "PostScoreResponse", "scopeKind": "class"}, {"_type": "tag", "name": "items", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    items: List[Game] = Field(..., description=\"List of games in the current page\")$/", "language": "Python", "typeref": "typename:List[Game]", "kind": "variable", "scope": "GameListResponse", "scopeKind": "class"}, {"_type": "tag", "name": "items", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    items: List[ScoreItem] = Field(..., description=\"List of scores\")$/", "language": "Python", "typeref": "typename:List[ScoreItem]", "kind": "variable", "scope": "ScoresResponse", "scopeKind": "class"}, {"_type": "tag", "name": "limit", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    limit: int = Field(..., description=\"Limit used\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "ScoresResponse", "scopeKind": "class"}, {"_type": "tag", "name": "list_games", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^def list_games($/", "language": "Python", "typeref": "typename:GameListResponse", "kind": "function", "signature": "( page: int = Query(1, ge=1, description=\"1-based page number\"), size: int = Query(10, ge=1, le=100, description=\"Page size\"), db: sqlite3.Connection = Depends(get_db_conn), )"}, {"_type": "tag", "name": "mode", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    mode: Literal[\"recent\", \"top\"] = Field(..., description=\"Selected mode\")$/", "language": "Python", "typeref": "typename:Literal[\"recent\", \"top\"]", "kind": "variable", "scope": "ScoresResponse", "scopeKind": "class"}, {"_type": "tag", "name": "name", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    name: str = Field(..., description=\"Display name for the game\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "Game", "scopeKind": "class"}, {"_type": "tag", "name": "page", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    page: int = Field(..., description=\"Current page (1-based)\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "GameListResponse", "scopeKind": "class"}, {"_type": "tag", "name": "post_game_score", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^def post_game_score($/", "language": "Python", "typeref": "typename:PostScoreResponse", "kind": "function", "signature": "( game_id: int, payload: PostScoreRequest, db: sqlite3.Connection = Depends(get_db_conn) )"}, {"_type": "tag", "name": "router", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^router = APIRouter(prefix=\"\\/games\", tags=[\"Games\"])$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "score", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    score: int = Field(..., description=\"Score value\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "ScoreItem", "scopeKind": "class"}, {"_type": "tag", "name": "score", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    score: int = Field(..., ge=0, description=\"Score to record (non-negative)\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "PostScoreRequest", "scopeKind": "class"}, {"_type": "tag", "name": "size", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    size: int = Field(..., description=\"Page size\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "GameListResponse", "scopeKind": "class"}, {"_type": "tag", "name": "slug", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    slug: str = Field(..., description=\"Unique game slug\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "Game", "scopeKind": "class"}, {"_type": "tag", "name": "stats", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    stats: Dict[str, Any] = Field($/", "language": "Python", "typeref": "typename:Dict[str, Any]", "kind": "variable", "scope": "PostScoreResponse", "scopeKind": "class"}, {"_type": "tag", "name": "total", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    total: int = Field(..., description=\"Total games count\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "GameListResponse", "scopeKind": "class"}, {"_type": "tag", "name": "user_id", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    user_id: int = Field(..., description=\"User ID who achieved this score\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "ScoreItem", "scopeKind": "class"}, {"_type": "tag", "name": "user_id", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/routes/games.py", "pattern": "/^    user_id: int = Field(..., ge=1, description=\"User ID\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "PostScoreRequest", "scopeKind": "class"}], "hash": "2999d3a1fb443a5a11e8c9f19b396f64", "format-version": 4, "code-base-name": "gaming_backend", "filename": "gaming_backend/src/api/routes/games.py", "fields": [{"name": "CREATE_GAMES_SQL = \"\"\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Tuple[str, ...] CREATE_INDEXES_SQL", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "CREATE_SCORES_SQL = \"\"\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Optional[str] created_at", "scope": "Game", "scopeKind": "class", "description": "unavailable"}, {"name": "Optional[str] description", "scope": "Game", "scopeKind": "class", "description": "unavailable"}, {"name": "Game game", "scope": "PostScoreResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "int id", "scope": "Game", "scopeKind": "class", "description": "unavailable"}, {"name": "ScoreItem inserted", "scope": "PostScoreResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "List[Game] items", "scope": "GameListResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "List[ScoreItem] items", "scope": "ScoresResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "int limit", "scope": "ScoresResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "Literal[\"recent\", \"top\"] mode", "scope": "ScoresResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "str name", "scope": "Game", "scopeKind": "class", "description": "unavailable"}, {"name": "int page", "scope": "GameListResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "router = APIRouter(prefix=\"\\/games\", tags=[\"Games\"])", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "int score", "scope": "ScoreItem", "scopeKind": "class", "description": "unavailable"}, {"name": "int size", "scope": "GameListResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "str slug", "scope": "Game", "scopeKind": "class", "description": "unavailable"}, {"name": "Dict[str, Any] stats", "scope": "PostScoreResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "int total", "scope": "GameListResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "int user_id", "scope": "ScoreItem", "scopeKind": "class", "description": "unavailable"}]}