{"is_source_file": true, "format": "Python", "description": "This file contains data models and utility functions related to user authentication, token handling, and user data management for an API within a gaming backend platform. It includes token signing and verification, user profile models, and database operations for the 'users' table.", "external_files": ["os", "base64", "hmac", "time", "sqlite3"], "external_methods": ["os.getenv", "base64.urlsafe_b64encode", "base64.urlsafe_b64decode", "hmac.new", "hmac.compare_digest", "json.dumps", "json.loads"], "published": ["get_secret_key", "sign_token", "verify_token", "MockLoginRequest", "TokenResponse", "UserProfile", "ensure_user_table", "upsert_user", "get_user_by_id"], "classes": [{"name": "MockLoginRequest", "description": "API data model for user login request payload, capturing email, name, avatar URL, and locale."}, {"name": "TokenResponse", "description": "API response model containing the signed token and token type."}, {"name": "UserProfile", "description": "Data model representing user profile information fetched from the database, including ID, email, name, avatar URL, and locale."}], "methods": [{"name": "bytes get_secret_key(env_var: str = \"SECRET_KEY\")", "description": "Fetches the secret key used for token signing from environment variables.", "scope": "", "scopeKind": ""}, {"name": "str sign_token(payload: Dict[str, Any], ttl_seconds: int = 60 * 60 * 24)", "description": "Creates and returns a signed HMAC token with embedded claims and expiration.", "scope": "", "scopeKind": ""}, {"name": "Dict[str,Any] verify_token(token: str)", "description": "Verifies and decodes a token, ensuring integrity and validity, and checks expiration.", "scope": "", "scopeKind": ""}, {"name": "None ensure_user_table(conn: sqlite3.Connection)", "description": "Ensures the 'users' table exists in the database.", "scope": "", "scopeKind": ""}, {"name": "int upsert_user(conn: sqlite3.Connection, email: str, name: str, avatar_url: Optional[str], locale: Optional[str])", "description": "Inserts or updates a user record in the database, returning the user ID.", "scope": "", "scopeKind": ""}, {"name": "Optional[UserProfile] get_user_by_id(conn: sqlite3.Connection, user_id: int)", "description": "Retrieves a user profile from the database by user ID.", "scope": "", "scopeKind": ""}, {"name": "str _b64u(data: bytes)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "bytes _b64u_decode(s: str)", "scope": "", "scopeKind": "", "description": "unavailable"}], "calls": ["os.getenv", "base64.urlsafe_b64encode", "base64.urlsafe_b64decode", "hmac.new", "hmac.compare_digest", "json.dumps", "json.loads", "ensure_user_table", "conn.cursor", "cursor.execute", "cursor.fetchone", "conn.commit"], "search-terms": ["token signing", "user database", "API models", "sqlite3 user", "JWT-like token", "pydantic models", "user profile", "authentication", "environment secret"], "state": 2, "file_id": 6, "knowledge_revision": 17, "git_revision": "", "ctags": [{"_type": "tag", "name": "CREATE_USERS_SQL", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^CREATE_USERS_SQL = \"\"\"$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "MockLoginRequest", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^class MockLoginRequest(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "TokenResponse", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^class TokenResponse(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "UserProfile", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^class UserProfile(BaseModel):$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "_b64u", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^def _b64u(data: bytes) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(data: bytes)"}, {"_type": "tag", "name": "_b64u_decode", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^def _b64u_decode(s: str) -> bytes:$/", "language": "Python", "typeref": "typename:bytes", "kind": "function", "signature": "(s: str)"}, {"_type": "tag", "name": "access_token", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^    access_token: str = Field(..., description=\"Signed HMAC token.\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "TokenResponse", "scopeKind": "class"}, {"_type": "tag", "name": "avatar_url", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^    avatar_url: Optional[str] = Field($/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "MockLoginRequest", "scopeKind": "class"}, {"_type": "tag", "name": "avatar_url", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^    avatar_url: Optional[str] = Field(None, description=\"Avatar URL.\")$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "UserProfile", "scopeKind": "class"}, {"_type": "tag", "name": "email", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^    email: EmailStr = Field(..., description=\"User email address for mock login.\")$/", "language": "Python", "typeref": "typename:EmailStr", "kind": "variable", "scope": "MockLoginRequest", "scopeKind": "class"}, {"_type": "tag", "name": "email", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^    email: EmailStr = Field(..., description=\"User email.\")$/", "language": "Python", "typeref": "typename:EmailStr", "kind": "variable", "scope": "UserProfile", "scopeKind": "class"}, {"_type": "tag", "name": "ensure_user_table", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^def ensure_user_table(conn: sqlite3.Connection) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(conn: sqlite3.Connection)"}, {"_type": "tag", "name": "get_secret_key", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^def get_secret_key(env_var: str = \"SECRET_KEY\") -> bytes:$/", "language": "Python", "typeref": "typename:bytes", "kind": "function", "signature": "(env_var: str = \"SECRET_KEY\")"}, {"_type": "tag", "name": "get_user_by_id", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^def get_user_by_id(conn: sqlite3.Connection, user_id: int) -> Optional[UserProfile]:$/", "language": "Python", "typeref": "typename:Optional[UserProfile]", "kind": "function", "signature": "(conn: sqlite3.Connection, user_id: int)"}, {"_type": "tag", "name": "id", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^    id: int = Field(..., description=\"User ID.\")$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "UserProfile", "scopeKind": "class"}, {"_type": "tag", "name": "locale", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^    locale: Optional[str] = Field($/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "MockLoginRequest", "scopeKind": "class"}, {"_type": "tag", "name": "locale", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^    locale: Optional[str] = Field(None, description=\"Preferred locale.\")$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "variable", "scope": "UserProfile", "scopeKind": "class"}, {"_type": "tag", "name": "name", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^    name: str = Field(..., description=\"Display name of the user.\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "MockLoginRequest", "scopeKind": "class"}, {"_type": "tag", "name": "name", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^    name: str = Field(..., description=\"Display name.\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "UserProfile", "scopeKind": "class"}, {"_type": "tag", "name": "sign_token", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^def sign_token(payload: Dict[str, Any], ttl_seconds: int = 60 * 60 * 24) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(payload: Dict[str, Any], ttl_seconds: int = 60 * 60 * 24)"}, {"_type": "tag", "name": "token_type", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^    token_type: str = Field(\"bearer\", description=\"Token type.\")$/", "language": "Python", "typeref": "typename:str", "kind": "variable", "scope": "TokenResponse", "scopeKind": "class"}, {"_type": "tag", "name": "upsert_user", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^def upsert_user(conn: sqlite3.Connection, email: str, name: str, avatar_url: Optional[str], loca/", "language": "Python", "typeref": "typename:int", "kind": "function", "signature": "(conn: sqlite3.Connection, email: str, name: str, avatar_url: Optional[str], locale: Optional[str])"}, {"_type": "tag", "name": "verify_token", "path": "/home/kavia/workspace/code-generation/mygov-citizen-engagement-games-platform-217305-217314/gaming_backend/src/api/models.py", "pattern": "/^def verify_token(token: str) -> Dict[str, Any]:$/", "language": "Python", "typeref": "typename:Dict[str,Any]", "kind": "function", "signature": "(token: str)"}], "hash": "a69a9a5c2cbc8df2d232fbe159ac80a0", "format-version": 4, "code-base-name": "gaming_backend", "filename": "gaming_backend/src/api/models.py", "fields": [{"name": "CREATE_USERS_SQL = \"\"\"", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "str access_token", "scope": "TokenResponse", "scopeKind": "class", "description": "unavailable"}, {"name": "Optional[str] avatar_url", "scope": "MockLoginRequest", "scopeKind": "class", "description": "unavailable"}, {"name": "EmailStr email", "scope": "MockLoginRequest", "scopeKind": "class", "description": "unavailable"}, {"name": "int id", "scope": "UserProfile", "scopeKind": "class", "description": "unavailable"}, {"name": "Optional[str] locale", "scope": "MockLoginRequest", "scopeKind": "class", "description": "unavailable"}, {"name": "str name", "scope": "MockLoginRequest", "scopeKind": "class", "description": "unavailable"}, {"name": "str token_type", "scope": "TokenResponse", "scopeKind": "class", "description": "unavailable"}], "revision_history": [{"17": ""}]}